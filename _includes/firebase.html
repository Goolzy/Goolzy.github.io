{% if site.firebase and site.firebase.enabled %}
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-check-compat.js"></script>
  <!-- Firebase Config JSON (rendered by Jekyll) -->
  <script id="firebase-config" type="application/json">{{ site.firebase | jsonify }}</script>
  <!-- Initialize Firebase -->
  <script>
  (function(){
    try {
      var cfgNode = document.getElementById('firebase-config');
      var siteFirebase = {};
      if (cfgNode) { try { siteFirebase = JSON.parse(cfgNode.textContent || '{}') || {}; } catch(_e){} }
      var cfg = siteFirebase.config || {};
      // Optional host allowlist: if provided, only initialize on matching hostnames
      try {
        var allow = siteFirebase && siteFirebase.allowed_hosts;
        if (Array.isArray(allow) && allow.length > 0) {
          var host = (location && location.hostname) || '';
          var ok = allow.indexOf(host) !== -1;
          if (!ok) { console.warn('Firebase init skipped: host not allowed', host); window.__fbInitSkippedReason = 'host-not-allowed:' + host; return; }
        }
      } catch(_e){}
      if (!cfg.apiKey) { console.warn('Firebase enabled but apiKey is empty'); }
      window.firebaseApp = firebase.initializeApp(cfg);
      // Optional: App Check (reCAPTCHA v3 or Enterprise). Configure in _config.yml -> firebase.app_check.*
      try {
        var appCheckCfg = (siteFirebase && siteFirebase.app_check) || {};
        var qs = (location && location.search) ? location.search : '';
  var appCheckEnabled = (appCheckCfg && appCheckCfg.enabled === false) ? false : true;
  try { if (sessionStorage.getItem('__disable_appcheck') === '1') appCheckEnabled = false; } catch(_e){}
        if (qs.indexOf('appcheck=off') !== -1) appCheckEnabled = false;
        var debugAppCheck = !!(appCheckCfg && appCheckCfg.debug) || (qs.indexOf('appcheck=debug') !== -1);
        if (debugAppCheck) { try { self.FIREBASE_APPCHECK_DEBUG_TOKEN = true; } catch(_e){} }
        if (appCheckEnabled && appCheckCfg) {
          var autoRefresh = (appCheckCfg.auto_refresh !== false);
          var provider = (appCheckCfg.provider || 'v3').toLowerCase();
          var key = appCheckCfg.site_key;
          if (provider === 'enterprise' && appCheckCfg.site_key_enterprise) key = appCheckCfg.site_key_enterprise;
          if (provider === 'v3' && appCheckCfg.site_key_v3) key = appCheckCfg.site_key_v3;
          if (!key) { window.__appCheckActivated = 'skipped'; }
          // Let Firebase SDK handle loading of reCAPTCHA; avoid custom injection to prevent CORS issues
          try {
            firebase.appCheck().activate(key, autoRefresh);
            window.__appCheckActivated = true;
          } catch(e){ console.warn('App Check activate error', e); window.__appCheckActivated = false; }
        } else {
          window.__appCheckActivated = 'skipped';
        }
      } catch(e){ console.warn('App Check init warning', e); window.__appCheckActivated = false; }
      window.__fbInit = true;
  var auth = firebase.auth();
  // Use browser/device language for Firebase emails (e.g., password reset)
  try { auth.useDeviceLanguage(); } catch(_e) {}
  try { auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL); }
  catch(_e1){
    try { auth.setPersistence(firebase.auth.Auth.Persistence.SESSION); window.__fbPersistence = 'SESSION'; }
    catch(_e2){ window.__fbPersistence = 'NONE'; }
  }

      // Providers from config
      var ap = siteFirebase.auth_providers || {};
      var providers = {};
      if (ap.google) {
        providers.google = new firebase.auth.GoogleAuthProvider();
        try { providers.google.setCustomParameters({ prompt: 'select_account' }); } catch(_e) {}
      }
      if (ap.apple) {
        providers.apple = new firebase.auth.OAuthProvider('apple.com');
        try {
          providers.apple.addScope('email');
          providers.apple.addScope('name');
        } catch(_e) {}
      }
      if (ap.microsoft) {
        providers.microsoft = new firebase.auth.OAuthProvider('microsoft.com');
        try { providers.microsoft.setCustomParameters({ prompt: 'select_account' }); } catch(_e) {}
      }

      // Bridge
      function maybeDisableAppCheckAndReload(err){
        try {
          var msg = (err && (err.code || err.message)) ? (String(err.code) + ' ' + String(err.message)) : '';
          if (/appcheck|recaptcha/i.test(msg)){
            sessionStorage.setItem('__disable_appcheck', '1');
            var url = location.pathname + location.search + (location.search ? '&' : '?') + 'appcheck=off';
            location.replace(url);
            return true;
          }
        } catch(_e){}
        return false;
      }

      window.AuthBridge = {
        onChange: function(cb){ return auth.onAuthStateChanged(cb); },
        currentUser: function(){ return auth.currentUser; },
        emailSignUp: function(email, password){
          return auth.createUserWithEmailAndPassword(email, password).catch(function(e){
            if (maybeDisableAppCheckAndReload(e)) return new Promise(function(){});
            throw e;
          });
        },
        emailSignIn: function(email, password){
          return auth.signInWithEmailAndPassword(email, password).catch(function(e){
            if (maybeDisableAppCheckAndReload(e)) return new Promise(function(){});
            throw e;
          });
        },
        sendPasswordReset: function(email){
          try {
            var acs = undefined;
            if (siteFirebase && siteFirebase.redirect_uri) {
              acs = { url: siteFirebase.redirect_uri, handleCodeInApp: false };
            }
            return auth.sendPasswordResetEmail(email, acs);
          } catch(e) { return Promise.reject(e); }
        },
        signOut: function(){ return auth.signOut(); },
        deleteUser: function(){ return auth.currentUser ? auth.currentUser.delete() : Promise.resolve(); },
        signInWith: function(name){
          var p = providers[name];
          if(!p) return Promise.reject(new Error('Provider not configured: '+name));
          // Redirect-only to avoid popup windows; sign out first to clear stale sessions
          var doRedirect = function(){ return auth.signInWithRedirect(p); };
          try {
            // guard against multiple concurrent requests
            if (sessionStorage.getItem('__authRedirecting') === '1') {
              var err = new Error('Another auth operation is in progress');
              err.code = 'auth/operation-in-progress';
              return Promise.reject(err);
            }
            sessionStorage.setItem('__authRedirecting', '1');
            sessionStorage.setItem('postAuthRedirect', '/');
            // Best-effort: clear any previous firebase:* entries that may cause stale credentials
            for (var i = sessionStorage.length - 1; i >= 0; i--) {
              var k = sessionStorage.key(i);
              if (k && k.indexOf('firebase:') === 0) sessionStorage.removeItem(k);
            }
          } catch(_e){}
          return auth.signOut().catch(function(){ /* ignore */ }).then(doRedirect).catch(function(e){
            if (maybeDisableAppCheckAndReload(e)) return new Promise(function(){});
            throw e;
          });
        },
        getRedirectResult: function(){
          return auth.getRedirectResult().finally(function(){
            try { sessionStorage.removeItem('__authRedirecting'); } catch(_e){}
          });
        },
        sendEmailVerification: function(){
          if (!auth.currentUser) return Promise.reject(new Error('No authenticated user'));
          var acs = undefined;
          try {
            if (siteFirebase && siteFirebase.redirect_uri) acs = { url: siteFirebase.redirect_uri };
          } catch(_e){}
          try { auth.useDeviceLanguage(); } catch(_e){}
          return auth.currentUser.sendEmailVerification(acs);
        }
      };
  try { window.dispatchEvent(new CustomEvent('auth:bridge-ready')); } catch(_e){}
    } catch(e) {
      console.error('Firebase init error', e);
    }
  })();
  </script>
{% endif %}

