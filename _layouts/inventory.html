---
layout: page
hide_sidebar: true
---
<div id="inventory-root">
  <div class="inventory-frame">
    <!-- Loading state -->
    <div id="inv-loading" style="text-align:center; padding:2rem;">
      <p>로딩 중...</p>
    </div>

    <!-- Locked (need login) -->
    <div id="inv-locked" style="display:none;">
      <h2 style="text-align:center;">Inventory</h2>
      <p style="text-align:center; margin-bottom:1.5rem;">이 페이지는 로그인 후 이용할 수 있습니다.</p>
      
      <div class="login-card" style="max-width:400px; margin:0 auto; padding:1.5rem; border:1px solid #e5e7eb; border-radius:12px;">
        <form id="inv-login-form" onsubmit="return false;">
          <label style="display:block; margin-bottom:1rem;">
            이메일
            <input name="email" type="email" required placeholder="name@example.com" style="width:100%; padding:.5rem; margin-top:.25rem;">
          </label>
          <label style="display:block; margin-bottom:1rem;">
            비밀번호
            <input name="password" type="password" required minlength="8" placeholder="8자 이상" style="width:100%; padding:.5rem; margin-top:.25rem;">
          </label>
          <div style="display:flex; gap:.5rem; margin-bottom:1rem;">
            <button class="btn" id="inv-signin-btn" type="button">로그인</button>
            <button class="btn btn--outline" id="inv-signup-btn" type="button">가입</button>
          </div>
        </form>

        <div style="text-align:center; margin:1rem 0; color:#6b7280;">또는</div>

        <div style="display:flex; flex-direction:column; gap:.5rem; align-items:center;">
          <a href="#" id="inv-google-btn" style="display:block;">
            <img src="/assets/images/auth/google-signin.svg" alt="Sign in with Google" style="height:40px;">
          </a>
          <a href="#" id="inv-apple-btn" style="display:block;">
            <img src="/assets/images/auth/apple-signin.svg" alt="Sign in with Apple" style="height:40px;">
          </a>
          <a href="#" id="inv-ms-btn" style="display:block;">
            <img src="/assets/images/auth/microsoft-signin.svg" alt="Sign in with Microsoft" style="height:40px;">
          </a>
        </div>

        <div id="inv-error" style="display:none; margin-top:1rem; padding:.75rem; background:#fee; border:1px solid #fcc; border-radius:6px; color:#c00;"></div>
      </div>
    </div>

    <!-- Unlocked (logged in) -->
    <div id="inv-unlocked" style="display:none;">
      <nav style="display:flex; gap:.5rem; padding:.5rem 0 1rem; border-bottom:1px solid #e5e7eb; flex-wrap:wrap;">
        <a href="/inventory/intro/" class="nav-link">소개</a>
        <a href="/inventory/manual/" class="nav-link">매뉴얼</a>
        <a href="/inventory/faq/" class="nav-link">FAQ</a>
        <a href="/inventory/suggest/" class="nav-link">건의하기</a>
        <a href="/inventory/bug-report/" class="nav-link">버그 리포트</a>
        <span style="flex:1"></span>
        <a href="/" style="padding:.35rem .6rem; color:#6b7280;">Home</a>
        <button id="inv-logout-btn" class="btn" type="button">로그아웃</button>
      </nav>
      
      <div style="padding-top:1rem;">
        {{ content }}
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  var loading = document.getElementById('inv-loading');
  var locked = document.getElementById('inv-locked');
  var unlocked = document.getElementById('inv-unlocked');
  var loginForm = document.getElementById('inv-login-form');
  var signinBtn = document.getElementById('inv-signin-btn');
  var signupBtn = document.getElementById('inv-signup-btn');
  var googleBtn = document.getElementById('inv-google-btn');
  var appleBtn = document.getElementById('inv-apple-btn');
  var msBtn = document.getElementById('inv-ms-btn');
  var logoutBtn = document.getElementById('inv-logout-btn');
  var errorBox = document.getElementById('inv-error');

  var POST_AUTH_KEY = 'postAuthRedirect';

  function showLoading(){ loading.style.display=''; locked.style.display='none'; unlocked.style.display='none'; }
  function showLocked(){ loading.style.display='none'; locked.style.display=''; unlocked.style.display='none'; }
  function showUnlocked(){ loading.style.display='none'; locked.style.display='none'; unlocked.style.display=''; }
  
  function showError(msg){
    if(!errorBox) return;
    errorBox.textContent = msg;
    errorBox.style.display = 'block';
  }
  function clearError(){ if(errorBox) errorBox.style.display='none'; }

  function saveRedirect(){
    try { sessionStorage.setItem(POST_AUTH_KEY, location.pathname); } catch(e){}
  }

  function init(){
    if(!window.AuthBridge){
      showError('인증 시스템을 초기화할 수 없습니다.');
      showLocked();
      return;
    }

    var redirectHandled = false;

    // Check auth state
    AuthBridge.onChange(function(user){
      if(user){
        showUnlocked();
      } else {
        showLocked();
      }
    });

    // Handle redirect result
    AuthBridge.getRedirectResult().then(function(result){
      if(result && result.user){
        console.log('OAuth 로그인 성공:', result.user.email);
        redirectHandled = true;
        
        // Get redirect destination
        var dest = '/inventory/';
        try {
          var stored = sessionStorage.getItem(POST_AUTH_KEY);
          if(stored) dest = stored;
          sessionStorage.removeItem(POST_AUTH_KEY);
        } catch(e){}
        
        // Redirect after short delay to ensure state updates
        setTimeout(function(){ 
          location.assign(dest);
        }, 100);
      }
    }).catch(function(e){
      // Ignore benign errors
      if(e && (e.code === 'auth/no-auth-event' || e.code === 'auth/user-cancelled' || e.code === 'auth/popup-closed-by-user')){
        return;
      }
      // Show other errors
      showError(e.message || '로그인 실패');
    });
  }

  // Email login
  if(signinBtn) signinBtn.addEventListener('click', function(){
    if(!loginForm.reportValidity()) return;
    clearError();
    saveRedirect();
    
    var email = loginForm.email.value.trim();
    var password = loginForm.password.value;
    
    AuthBridge.emailSignIn(email, password).then(function(){
      // Success - onChange will handle UI
    }).catch(function(e){
      showError(e.message || '로그인 실패');
    });
  });

  // Email signup
  if(signupBtn) signupBtn.addEventListener('click', function(){
    if(!loginForm.reportValidity()) return;
    clearError();
    saveRedirect();
    
    var email = loginForm.email.value.trim();
    var password = loginForm.password.value;
    
    AuthBridge.emailSignUp(email, password).then(function(){
      // Success - onChange will handle UI
    }).catch(function(e){
      showError(e.message || '가입 실패');
    });
  });

  // OAuth
  function oauth(provider){
    clearError();
    saveRedirect();
    
    console.log('Inventory OAuth 시작:', provider);
    
    // Use POPUP instead of redirect
    AuthBridge.signInWithPopup(provider).then(function(result){
      console.log('Inventory popup 로그인 성공:', result.user.email);
      
      // Get redirect destination
      var dest = '/inventory/';
      try {
        var stored = sessionStorage.getItem(POST_AUTH_KEY);
        if(stored) dest = stored;
        sessionStorage.removeItem(POST_AUTH_KEY);
      } catch(e){}
      
      // Redirect after short delay
      setTimeout(function(){ 
        console.log('Inventory 리다이렉트:', dest);
        location.assign(dest);
      }, 100);
    }).catch(function(e){
      if(e && (e.code === 'auth/popup-closed-by-user' || e.code === 'auth/user-cancelled')){
        console.log('팝업 취소됨');
        return;
      }
      showError(e.message || 'OAuth 로그인 실패');
    });
  }

  if(googleBtn) googleBtn.addEventListener('click', function(e){ e.preventDefault(); oauth('google'); });
  if(appleBtn) appleBtn.addEventListener('click', function(e){ e.preventDefault(); oauth('apple'); });
  if(msBtn) msBtn.addEventListener('click', function(e){ e.preventDefault(); oauth('microsoft'); });

  // Logout
  if(logoutBtn) logoutBtn.addEventListener('click', function(){
    AuthBridge.signOut().then(function(){
      location.assign('/inventory/');
    });
  });

  // Initialize
  if(window.AuthBridge){
    init();
  } else {
    window.addEventListener('auth:bridge-ready', init, {once:true});
  }
})();
</script>

<style>
.inventory-frame{
  max-width: 960px;
  margin: 0 auto;
  padding: 1rem;
}
.nav-link{
  padding: .4rem .75rem;
  border-radius: 6px;
  background: #f3f4f6;
  text-decoration: none;
  color: #374151;
}
.nav-link:hover{
  background: #e5e7eb;
}
</style>
